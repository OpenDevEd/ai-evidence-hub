{%- from "kerkoapp/_badges.html.jinja2" import badges %}
{%- from "macros/icons/opendeved-small-icon.jinja2" import opendevedSmallIcon %}
{%- from "macros/icons/documentIcon.jinja2" import documentIcon %}

<li class="{% block search_list_item_classes %} search-item break-word {% endblock %}">
    {%- if print_preview -%}
    {%- block search_item_print %}
    {{- badges(result, mode='result') -}}
    {%- block search_item_formatted_print %}
    {{- result.bib|safe -}}
    {%- endblock search_item_formatted_print %}
    {%- endblock search_item_print %}
    {%- else -%}
    {%- block search_item_display %}
    <div class="d-flex">
        <a class="searchResultTitle {% block search_item_classes %}d-block mw-100 mr-auto{% endblock %}"
            href="{{ result_url }}" title="{{ _('View details') }}">
            {# {{- badges(result, mode='result') -}} #}
            {# {{- result.data['tags'] -}} #}
            {%- block search_item_formatted_display %}
            <span>{{- result.data['title'] -}}</span>
            {%- endblock search_item_formatted_display %}
        </a>
        {%- if result.coins %}
        {{- result.coins|safe -}}
        {%- endif %}
    </div>
    {%- endblock search_item_display %}

    {%- block Info %}
    <div class="info d-none d-lg-flex flex-row flex-wrap">
        {%- if result.data['institution'] %}
        <div class="d-flex align-items-center institution-class">
            {%- if result.data['institution'] == "Open Development & Education"%}
            <span class="mr-1">{{ opendevedSmallIcon("", 24, 24) }}</span>
            {%- endif %}
            <span style="font-weight: 500;">{{ result.data['institution'][:28] }}{% if result.data['institution']|length
                > 28 %}...{% endif %}</span>
        </div>
        {%- endif %}
        {%- if result.data['creators']|length and not result.data['institution'] %}
        <div class="d-flex align-items-center institution-class">
            <span>{{ result.data['creators']|format_creators(40) }}</span>
        </div>
        {%- endif %}

        {%- if result.data['date'] %}
        {%- if result.data['creators']|length or result.data['institution'] %}
        <span class="mx-2">|</span>
        {%- endif %}
        <div class="d-flex align-items-center institution-class">
            <span>{{ result.data['date']|format_date() }}</span>
        </div>
        {%- endif %}

        {%- if result.data['itemType'] and not is_coming_soon(result) %}
        {%- if result.data['creators']|length or result.data['institution'] or result.data['date'] %}
        <span class="mx-2">|</span>
        {%- endif %}
        <div class="d-flex align-items-center institution-class">
            <span>{{ result.data['itemType']|string }}</span>
        </div>
        {%- endif %}

        {%- if is_coming_soon(result) %}
        {%- if result.data['creators']|length or result.data['institution'] or result.data['date'] %}
        <span class="mx-2">|</span>
        {%- endif %}
        <div class="d-lg-flex d-none">
            <span class="in-progress-badge d-lg-flex d-none">In Progress</span>
        </div>
        {%- endif %}
    </div>

    <div class="info d-lg-none d-flex flex-column w-100" style="gap: 8px;">
        {%- if result.data['institution'] %}
        <div class="d-flex align-items-center institution-class">
            {%- if result.data['institution'] == "Open Development & Education"%}
            <span class="mr-1">{{ opendevedSmallIcon("", 24, 24) }}</span>
            {%- endif %}
            <span style="font-weight: 500;">{{ result.data['institution'][:28] }}{% if result.data['institution']|length
                > 28 %}...{% endif %}</span>
        </div>
        {%- endif %}

        {%- if result.data['creators']|length and not result.data['institution']%}
        <div class="d-flex align-items-center institution-class">
            <span>{{ result.data['creators']|format_creators(40) }}</span>
        </div>
        {%- endif %}

        {%- if result.data['date'] %}
        <div class="d-flex align-items-center institution-class">
            <span>{{ result.data['date']|format_date() }}</span>
        </div>
        {%- endif %}

        <div class="d-flex w-100">
            {%- if result.data['tags']|length > 1 %}
            {%- for tag in result.data['tags'] %}
            {%- if tag['tag'] == '_comingsoon' or tag['tag'] == 'Coming soon' %}
            <span class="in-progress-badge w-100 d-flex justify-content-center">In Progress</span>
            {%- endif %}
            {%- endfor %}
            {%- endif %}
        </div>
    </div>
    {%- endblock Info %}

    {%- endif -%}
    {%- if show_abstracts and result.data['abstractNote']|trim|length %}
    <p class="{% block search_abstract_classes %}search-abstract pre-line p-0 m-0{% endblock %}">
        {%- if config.kerko.features.results_abstracts_max_length > 0 %}
        {{- result.data['abstractNote']|truncate(
        config.kerko.features.results_abstracts_max_length,
        leeway=config.kerko.features.results_abstracts_max_length_leeway
        )|urlize(target='_blank', rel="noopener noreferrer")|trim -}}
        {%- else %}
        {{- result.data['abstractNote']|urlize(target='_blank', rel="noopener noreferrer")|trim
        -}}
        {%- endif %}
    </p>
    {%- endif %}
    {%- if not hide_result_links %}
    {%- block search_result_links %}
    {%- if result.attachments|length and config.kerko.features.results_attachment_links or result.url|kerko_url_hostname
    and config.kerko.features.results_url_links %}
    <div class="d-print-none btn-group {% block search_item_links_classes %} {% endblock %}">
        {%- if config.kerko.features.results_attachment_links and result.attachments|length > 1 %}
        {%- block search_result_link_multiple_attachments %}
        <div class="dropdown">
            <button
                class="{% block search_item_attachments_btn_classes %}btn btn-sm btn-link dropdown-toggle text-nowrap{% endblock %}"
                type="button" id="attachment-options-{{ result.id|escape }}" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                <span class=" mr-1" aria-hidden="true">
                    {{ documentIcon("", 20, 20) }}
                </span>
                {{ _('Read documents') -}}
            </button>
            <span class="dropdown-menu dropdown-menu-right dropdown-width-300"
                aria-labelledby="attachment-options-{{ result.id|escape }}">
                {%- for attachment in result.attachments %}
                <a class="dropdown-item"
                    href="{{ url_for('kerko.child_attachment_download', item_id=result.id, attachment_id=attachment['id'], attachment_filename=attachment['data']['filename']) }}"
                    {% if config.kerko.features.download_attachment_new_window %} target="_blank" rel="noopener" {%
                    endif %}>
                    {{- attachment['data']['filename']|escape }}
                </a>
                {%- endfor %}
            </span>
        </div>
        {%- endblock search_result_link_multiple_attachments %}
        {%- elif config.kerko.features.results_attachment_links and result.attachments|length == 1 %}
        {%- block search_result_link_single_attachment %}
        <a id="search-item-read-document" class="{% block search_item_attachment_btn_classes %}{% endblock %}"
            href="{{ url_for('kerko.child_attachment_download', item_id=result.id, attachment_id=result.attachments[0]['id'], attachment_filename=result.attachments[0]['data']['filename']) }}"
            {% if config.kerko.features.download_attachment_new_window %} target="_blank" rel="noopener" {% endif %} {{
            title_aria_label(_('Read \'{}\'').format(result.attachments[0]['data']['filename']|escape)) }}>
            <span class="" aria-hidden="true">
                {{ documentIcon("mb-1", 20, 20) }}
            </span>
            <span class="" aria-hidden="true">
                {{ _('Read document') -}}
            </span>
        </a>
        {%- endblock search_result_link_single_attachment %}
        {%- elif config.kerko.features.results_url_links and result.url|kerko_url_hostname %}
        {%- block search_result_link_url %}
        <a href="{{ result.url|kerko_url_sanitize|escape }}" target="_blank" rel="noopener noreferrer"
            id="search-item-link">
            <img class="mb-1" src="{{ url_for('static', filename='dist/icons/Link.svg') }}" alt="external link"
                aria-hidden="true" />
            <span aria-hidden="true">
                {{ _('View on {}').format(result.url|kerko_url_hostname|escape) }}
            </span>
        </a>
        {%- endblock search_result_link_url %}
        {%- endif %}
    </div>
    {%- endif %}
    {%- endblock search_result_links %}
    {%- endif %}
</li>